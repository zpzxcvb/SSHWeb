<!DOCTYPE html>
<html>
<head>
	<title>菜单信息列表</title>
	<link rel="stylesheet" href="/js/lib/layui/css/layui.css">
	<link rel="stylesheet" href="/js/lib/zTree/css/zTreeStyle/zTreeStyle.css">
	
	<script type="text/javascript" src="/js/lib/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="/js/lib/layui/layui.js"></script>
	<script type="text/javascript" src="/js/lib/zTree/jquery.ztree.core.js"></script>
</head>
<body style="padding: 15px">
	<div class="layui-row layui-col-space10">
		<div class="layui-col-md6">
			<div class="layui-card">
				<div class="layui-card-header">
					<div class="layui-inline table-search">
						<div class="layui-input-inline">
							<input class="layui-input" id="key" type="search" placeholder="请输入名称">
						</div>
						<a id="searchModel" class="layui-btn layui-btn-sm"><i class="layui-icon layui-icon-search"></i> 查询</a>
					</div>
				</div>
				<div class="layui-card-body">
					<div class="">
						<a id="addModel" class="layui-btn"><i class="layui-icon layui-icon-add-1"></i> 添加</a>
<!-- 						<a id="deleteModel" class="layui-btn layui-btn-danger"><i class="layui-icon layui-icon-delete"></i> 删除</a> -->
					</div>
					<table id="table" lay-filter="table_event"></table>
				</div>
			</div>
		</div>
		<div class="layui-col-md3">
			<div class="layui-card">
				<div class="layui-card-header">【<span id="role_name">超级管理员</span>】角色所属用户</div>
				<div class="layui-card-body">
					<table id="table_user"></table>
				</div>
			</div>
		</div>
		<div class="layui-col-md3">
			<div class="layui-card">
				<div class="layui-card-header">【<span id="role_permission">超级管理员</span>】角色所属权限</div>
				<div class="layui-card-body">
					<ul id="menuTree" class="ztree"></ul>
				</div>
			</div>
		</div>
	</div>
	<script type="text/html" id="rowbarTpl">
		<a title="编辑" class="layui-btn layui-btn-xs" lay-event="editModel"><i class="layui-icon layui-icon-edit"></i></a>
		<a title="分配权限" class="layui-btn layui-btn-xs" lay-event="grantMenu"><i class="layui-icon layui-icon-auz"></i></a>
	</script>
	<script type="text/javascript" src="/js/myjs.js"></script>
	<script>
	var table,tableIns,tableId='table';
	function initTable(table){
		var params = {
			 id: "#table",
			 url: "/sys/role/pageList",
			 columns: [
		    	{type: 'checkbox', fixed: 'left'},
		      	{type: 'numbers', title: '序号', fixed: 'left'},
		      	{field: 'roleName', title: '角色名称'},
		      	{field: 'description', title: '描述'},
// 		      	{field: 'createTime', title: '创建时间'},
		      	{fixed: 'right', title:'操作', fixed: 'right', toolbar: '#rowbarTpl'}
		    ]
		};
		tableIns = table_layui(table, params);
	}
	layui.use('table', function(){
		table = layui.table;
		//初始化table
		initTable(table);
		//监听按钮事件
		initFunction();
		active.loadRolePermission("");
		active.loadUserTable(table,"");
		//监听单击行事件
		  table.on('row(table_event)', function(obj){
			  $("#role_name").text(obj.data.roleName);
			  $("#role_permission").text(obj.data.roleName);
			  active.loadRolePermission(obj.data.roleId);
			  active.loadUserTable(table, obj.data.roleId);
		  });
	});
	var active = {
		searchModel: function(table){
			var key = $("#key").val();
			tableIns.reload({
				where:{key: key}
		  	});
		},
		addModel: function(){
			openDialog('/sys/role/saveOrUpdate');
		},
		deleteModel: function(){
			confirm_Delete("/sys/role/deleteByIds", "roleId");
		},
		editModel: function(data){
			openDialog('/sys/role/saveOrUpdate?id='+data.roleId);
		},
		grantMenu: function(data){
			layer.open({
				type: 2,
			  	area: ['500px', '400px'], //宽高
			  	content: '/sys/role/grantMenu?id='+data.roleId,
			  	btn: ['保存', '取消'],
			  	btnAlign: 'c',
			  	yes:function(index, layero){
			  		var iframeWin = window[layero.find('iframe')[0]['name']];
			  		iframeWin.saveRolePermission();//调用子页面方法
			  	}
			});
		},
		loadRolePermission(roleId){
			//初始化tree(非异步)
			initTree({
				id: "menuTree",
				url: "/sys/role/findPermissionByRoleId?roleId="+roleId,
			});
		},
		loadUserTable(table, roleId){
			var params = {
				 id: "#table_user",
				 url: "/sys/role/findUserByRoleId?roleId="+roleId,
				 columns: [
			      	{type: 'numbers', title: '序号', fixed: 'left'},
			      	{field: 'user_name', title: '用户名'},
			      	{field: 'status', title: '状态', sort: true, templet: function(d){
			        	return d.status == 1 ? "启用" : "<span style='color: red;'>禁用</span>";
				    }}
			    ]
			};
			table_layui(table, params);
		}
	}
	</script>
</body>
</html>