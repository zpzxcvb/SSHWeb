<!DOCTYPE html>
<html>
<head>
	<title>用户信息列表</title>
	<link rel="stylesheet" href="/js/lib/layui/css/layui.css">
	<link rel="stylesheet" href="/js/lib/zTree/css/zTreeStyle/zTreeStyle.css">
	
	<script src="/js/lib/layui/layui.js"></script>
	<script type="text/javascript" src="/js/lib/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="/js/lib/zTree/jquery.ztree.core.js"></script>
</head>
<body>
	<div class="layui-row layui-col-space10">
		<div class="layui-col-md9">
			<div class="layui-card">
				<div class="layui-card-header">
					<div class="layui-inline table-search">
						<div class="layui-input-inline">
							<input class="layui-input" id="key" type="search" placeholder="请输入名称">
						</div>
						<a id="searchModel" class="layui-btn layui-btn-sm"><i class="layui-icon layui-icon-search"></i> 查询</a>
					</div>
				</div>
				<div class="layui-card-body">
					<table id="table" lay-filter="table_event"></table>
				</div>
			</div>
		</div>
		<div class="layui-col-md3">
			<div class="layui-card">
				<div class="layui-card-header">【<span id="user_name"></span>】用户所属权限</div>
				<div class="layui-card-body">
					<ul id="menuTree" class="ztree"></ul>
				</div>
			</div>
		</div>
	</div>
	
	<script type="text/javascript" src="/js/myjs.js"></script>
	<script type="text/html" id="toolbars">
		<div id="" class="layui-btn-container">
			<a lay-event="addModel" class="layui-btn layui-btn-sm"><i class="layui-icon layui-icon-add-1"></i> 添加</a>
			<a lay-event="deleteModel" class="layui-btn layui-btn-sm layui-btn-danger"><i class="layui-icon layui-icon-delete"></i> 删除</a>
			<a lay-event="grantRole" class="layui-btn layui-btn-sm"><i class="layui-icon layui-icon-auz"></i> 分配角色</a>
		</div>
	</script>
	<script type="text/html" id="statusTpl">
		<input type='checkbox' name='status' lay-skin='switch' lay-text='可用|禁用' lay-filter='userStatus' {{ d.status == 1 ? 'checked' : '' }} value='{{d.userId}}'>
	</script>
	<script>
	var table,tableIns;
	function initTable(table){
		var params = {
			 id: "#table",
			 url: "/sys/user/pageList",
			 toolbar: '#toolbars',
			 columns: [
		    	{type: 'checkbox', fixed: 'left'},
		      	{type: 'numbers', title: '序号', fixed: 'left'},
		      	{field: 'user_name', title: '用户名'},
		      	{field: 'role_name', title: '所属角色'},
		      	{field: 'create_time', title: '创建时间', width: 170},
		      	{field: 'update_time', title: '更新时间', width: 170},
		      	{field: 'status', title: '状态', width: 100, sort: true, templet: '#statusTpl'}
		    ]
		};
		tableIns = table_layui(table, params);
	}
	layui.use(['table'], function(){
		form = layui.form;
		table = layui.table;
		//初始化table
		initTable(table);
		//监听工具条事件
		  table.on('toolbar(table_event)', function(obj){
		      var method = obj.event;
		      active[method] ? active[method].call(this, table) : '';
		  });
		//监听单击行事件
		  table.on('row(table_event)', function(obj){
			  $("#user_name").text(obj.data.user_name);
			  active.loadUserPermission(obj.data.user_id);
		  });
		  //监听普通按钮事件
		  $('.table-search .layui-btn').click(function(){
		  	  var method = this.id;
		  	  active[method] ? active[method].call(this, table) : '';
		  });
		//监听指定开关
		  form.on('switch(userStatus)', function(data){
		  	var status = this.checked ? 1 : 0;
		  	var userId = this.value;
		  	var url = "/sys/user/changeUserStatus";
		  	var param = {userId:userId, status:status};
		    layer.confirm('您确定要操作吗?', {icon: 3}, function(index){
				$.ajax({
					url: url,
					type: "post",
					data: param,
					success: function(data){
						if(data.code == "ok"){
							layer.msg(data.msg,{icon:1});
							layer.close(index);
						}else{
							layer.msg(data.msg,{icon:0});
						}
					}
				});
			},function (){
				tableIns.reload();
			});
		  });
	});
	var active = {
		searchModel: function(table){
			var key = $("#key").val();
			tableIns.reload({
				where:{key: key}
		  	});
		},
		addModel: function(table){
			openDialog(table, 'table', '/sys/user/goAdd');
		},
		deleteModel: function(table){
			confirm_Delete(table, 'table', "/sys/user/deleteByIds", "user_id");
		},
		grantRole: function(table){
			editDialog(table, 'table', '/sys/user/grantRole', "user_id");
		},
		loadUserPermission(userId){
			//初始化tree(非异步)
			initTree({
				id: "menuTree",
				url: "/sys/user/findPermissionByUserId?userId="+userId,
			});
		}
	}
	</script>

</body>
</html>